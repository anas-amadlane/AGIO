DROP TABLE IF EXISTS %s; CREATE TABLE %s (DATE_OP DATE, DATE_VA DATE, DEBIT BIGINT, CREDIT BIGINT);

CREATE TABLE IF NOT EXISTS BQ_SPEC(BQ VARCHAR, SOLDE DECIMAL, LINE DECIMAL, LINE_SDATE DATE, LINE_EDATE DATE, REG_TX DECIMAL, REG_SDATE DATE, REG_EDATE DATE, PLA_TX DECIMAL, PLA_SDATE DATE, PLA_EDATE DATE);

DROP VIEW IF EXISTS BMCE_CONC_OP; CREATE VIEW IF NOT EXISTS BMCE_CONC_OP AS WITH tmp AS (
    SELECT
        DATE(DATE_OP) AS S_DATE, SUM(DEBIT) AS S_DEBIT, SUM(CREDIT) AS S_CREDIT FROM BMCE_2023_1
        GROUP BY DATE(DATE_OP)
    UNION ALL
    SELECT
        DATE(DATE_OP) AS S_DATE, SUM(DEBIT) AS S_DEBIT, SUM(CREDIT) AS S_CREDIT FROM BMCE_2023_2
        GROUP BY DATE(DATE_OP)
    UNION ALL
    SELECT
        DATE(DATE_OP) AS S_DATE, SUM(DEBIT) AS S_DEBIT, SUM(CREDIT) AS S_CREDIT FROM BMCE_2023_3
        GROUP BY DATE(DATE_OP)
)
SELECT
    (WITH RECURSIVE date_sequence AS (SELECT date('2023-04-01') AS date UNION ALL SELECT date(date_sequence.date, '+1 day') FROM date_sequence WHERE strftime('%Y-%m', date_sequence.date) < '2023-07') SELECT date FROM date_sequence WHERE strftime('%Y-%m', date) < '2023-07') AS S_DATE, S_DEBIT, S_CREDIT,
    (
        SELECT
            (SELECT SOLDE FROM BQ_SPEC WHERE BQ='BMCE') + (SUM(S_CREDIT) - SUM(S_DEBIT))
        FROM tmp
        WHERE S_DATE <= o.S_DATE
    ) AS BALANCE FROM tmp o
GROUP BY DATE(S_DATE) ORDER BY S_DATE;

DROP VIEW IF EXISTS BMCE_NB_DEB_CRE; CREATE VIEW IF NOT EXISTS TEST AS WITH TEST (
    SELECT
        DATE(S_DATE) AS DATE,
        CASE
          WHEN BALANCE >= 0 THEN BALANCE
          ELSE 0
        END AS NB_CRE,
        CASE
          WHEN BALANCE >= 0 THEN 0
          WHEN -1 * BALANCE <= (SELECT LINE FROM BQ_SPEC WHERE BQ='BMCE') THEN -1 * BALANCE
          ELSE (SELECT LINE FROM BQ_SPEC WHERE BQ='BMCE')
        END AS NB_DEB_REG,
        CASE
          WHEN BALANCE >= 0 THEN 0
          WHEN -1 * BALANCE <= (SELECT LINE FROM BQ_SPEC WHERE BQ='BMCE') THEN 0
          ELSE -1 * BALANCE - (SELECT LINE FROM BQ_SPEC WHERE BQ='BMCE')
        END AS NB_DEB_PLA
    FROM CONC_TEST
)
SELECT DATE, NB_CRE, NB_DEB_REG, NB_DEB_PLA, ((NB_DEB_REG * (SELECT REG_TX FROM BQ_SPEC WHERE BQ='BMCE')/100)/360 + (NB_DEB_PLA * (SELECT PLA_TX FROM BQ_SPEC WHERE BQ='BMCE')/100)/360) AS INTER
FROM TEST;


DROP VIEW IF EXISTS %s_NB_DEB_CRE; CREATE VIEW IF NOT EXISTS %s_NB_DEB_CRE AS WITH %s_NB_DEB_CRE (
    SELECT
        DATE(S_DATE) AS DATE,
        CASE
          WHEN BALANCE >= 0 THEN BALANCE
          ELSE 0
        END AS NB_CRE,
        CASE
          WHEN BALANCE >= 0 THEN 0
          WHEN -1 * BALANCE <= (SELECT LINE FROM BQ_SPEC WHERE BQ='BMCE') THEN -1 * BALANCE
          ELSE (SELECT LINE FROM BQ_SPEC WHERE BQ='BMCE')
        END AS NB_DEB_REG,
        CASE
          WHEN BALANCE >= 0 THEN 0
          WHEN -1 * BALANCE <= (SELECT LINE FROM BQ_SPEC WHERE BQ='BMCE') THEN 0
          ELSE -1 * BALANCE - (SELECT LINE FROM BQ_SPEC WHERE BQ='BMCE')
        END AS NB_DEB_PLA
    FROM CONC_TEST
)
SELECT DATE, NB_CRE, NB_DEB_REG, NB_DEB_PLA, ((NB_DEB_REG * (SELECT REG_TX FROM BQ_SPEC WHERE BQ='BMCE')/100)/360 + (NB_DEB_PLA * (SELECT PLA_TX FROM BQ_SPEC WHERE BQ='BMCE')/100)/360) AS INTER
FROM TEST;


